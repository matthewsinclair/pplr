#!/bin/bash

# USAGE: generate index.md based on contents of $PPLR_DIR


# Script name: people_index
# Description: Generate a markdown file listing all people from the directory structure, ignoring specific directories.

## Default location of PPLR_DIR if not already set
: "${PPLR_DATA:=$HOME/Dropbox/Career/People}"
: "${PPLR_DIR:=$PPLR_DATA}"
: "${PPLR_ROOT:=$(dirname "$(dirname "$(readlink -f "$0" 2>/dev/null || echo "$0")")")}"
: "${PPLR_BIN_DIR:=$PPLR_ROOT/bin}"
: "${PPLR_TEMPLATE_DIR:=$PPLR_ROOT/templates}"


# Define the base directory (set to the current directory for execution within "People/")
BASE_DIR="."

# Get the current date in YYYY-MM-DD format
current_date=$(date +%Y-%m-%d)

# Regular expression for directories to ignore
IGNORE_DIRS="^_Templates$|^bin$|^index(.*)\.md$|^index(.*)\.json$|^.DS_Store$|^Icon$"


# Print header for markdown file
echo '---'
echo "verblock: \"$current_date:v0.1: Generated by people_index\""
echo '---'
echo '# People Index'
echo ''  # Extra newline after the People Index heading

# Loop through each letter directory under the current directory
for letter_dir in "$BASE_DIR"/*; do
  letter=$(basename "$letter_dir")

  # Check if the directory should be ignored
  if [[ $letter =~ $IGNORE_DIRS ]]; then
    continue
  fi

  if [[ -d "$letter_dir" ]]; then
    echo "##### $letter"

    # Loop through each person directory under the letter directory
    first_person=true
    for person_dir in "$letter_dir"/*; do
      if [[ -d "$person_dir" ]]; then
        person_name=$(basename "$person_dir")

        # Extract Firstname and Surname
        IFS=', ' read -r surname firstname <<< "$person_name"

        # Form the correct about file name
        about_file="$firstname $surname (About).md"

        if [ "$first_person" = true ]; then
          echo "[$person_name](<./$letter/$person_name/About/$about_file>)"
          first_person=false
        else
          echo "[$person_name](<./$letter/$person_name/About/$about_file>)"
        fi
      fi
    done
    echo ''  # Ensure a newline after all entries under a letter
  fi
done
